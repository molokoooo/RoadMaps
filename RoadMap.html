<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoadMap Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              dark: {
                850: '#1a202c',
                950: '#0f172a'
              }
            }
          }
        }
      };
    </script>
    <style>
        .roadmap-item {
            transition: all 0.3s ease;
        }
        .roadmap-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .dark .roadmap-item:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }
        .timeline::before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 2px;
            background: #3b82f6;
            transform: translateX(-50%);
        }
        @media (max-width: 768px) {
            .timeline::before {
                left: 20px;
            }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Улучшенные стили для темной темы */
        .dark input, .dark textarea, .dark select {
            background-color: #1e293b;
            border-color: #334155;
            color: #e2e8f0;
        }
        .dark input::placeholder, .dark textarea::placeholder {
            color: #94a3b8;
        }
        .dark .bg-gradient-to-r {
            background-image: linear-gradient(to right, #1e40af, #4338ca);
        }
        .dark .stages-container {
            background-color: #1e293b;
            border-color: #334155;
        }
        .dark .stage-item {
            background-color: #1e293b;
        }
        .theme-toggle {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .stage-completed {
            opacity: 0.7;
        }
        .stage-completed .stage-content {
            border-left: 4px solid #10b981;
        }
        .stage-completed .stage-dot {
            background-color: #10b981;
        }
        .stage-completed .stage-title {
            text-decoration: line-through;
        }
        .mobile-hidden {
            display: none;
        }
        @media (min-width: 1024px) {
            .mobile-hidden {
                display: block;
            }
        }
        .mobile-full {
            grid-column: span 3 / span 3;
        }
        .mobile-create-btn {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 40;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }
        .close-create-panel {
            position: absolute;
            top: 1rem;
            right: 1rem;
        }
        
        /* Новые стили для улучшений */
        .stage-item {
            cursor: grab;
            transition: transform 0.2s;
        }
        .stage-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
            cursor: grabbing;
        }
        .stage-item.drag-over {
            border-top: 2px solid #3b82f6;
        }
        .tag {
            display: inline-flex;
            align-items: center;
            background-color: #dbeafe;
            color: #1d4ed8;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
        }
        .dark .tag {
            background-color: #1e3a8a;
            color: #93c5fd;
        }
        .tag-remove {
            margin-left: 0.25rem;
            cursor: pointer;
        }
        .progress-bar {
            height: 0.5rem;
            background-color: #e5e7eb;
            border-radius: 0.25rem;
            overflow: hidden;
        }
        .dark .progress-bar {
            background-color: #334155;
        }
        .progress-fill {
            height: 100%;
            background-color: #10b981;
            transition: width 0.5s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(20px); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .slide-in {
            animation: slideIn 0.3s ease forwards;
        }
        .slide-out {
            animation: slideOut 0.3s ease forwards;
        }
        .pulse {
            animation: pulse 1.5s infinite;
        }
        .stage-comment {
            background-color: #f3f4f6;
            border-left: 3px solid #3b82f6;
            padding: 0.75rem;
            border-radius: 0 0.375rem 0.375rem 0;
            margin-top: 0.5rem;
        }
        .dark .stage-comment {
            background-color: #1e293b;
            border-left: 3px solid #60a5fa;
        }
        .tag-filter {
            transition: all 0.2s ease;
        }
        .tag-filter.active {
            background-color: #3b82f6;
            color: white;
        }
        .dark .tag-filter.active {
            background-color: #1e40af;
        }
        @keyframes themeTogglePulse {
            0%   { transform: scale(1) rotate(0deg); }
            50%  { transform: scale(1.2) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
        }

        .theme-toggle.animate {
            animation: themeTogglePulse 0.4s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-dark-950 text-gray-900 dark:text-gray-200 min-h-screen">
    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 dark:from-blue-800 dark:to-indigo-900 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-map-marked-alt text-3xl"></i>
                    <h1 class="text-2xl font-bold">RoadMap Creator</h1>
                </div>
                <button id="toggleTheme" class="theme-toggle p-2 rounded-full bg-white dark:bg-gray-700 bg-opacity-20 dark:bg-opacity-30 hover:bg-opacity-30 dark:hover:bg-opacity-40 transition">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:inline"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Создание RoadMap -->
            <div id="createPanel" class="lg:col-span-1 bg-white dark:bg-dark-850 rounded-xl shadow-md p-6 h-fit sticky top-6 mobile-hidden">
                <button id="closeCreatePanel" class="close-create-panel lg:hidden p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                    <i class="fas fa-times"></i>
                </button>
                <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4 flex items-center">
                    <i class="fas fa-plus-circle mr-2 text-blue-500"></i> Создать RoadMap
                </h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Название RoadMap</label>
                        <input type="text" id="roadmapTitle" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Описание</label>
                        <textarea id="roadmapDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800"></textarea>
                    </div>
                    
                    <!-- Теги RoadMap -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Теги</label>
                        <div class="flex flex-wrap gap-2 mb-2" id="tagsContainer"></div>
                        <div class="flex">
                            <input type="text" id="tagInput" placeholder="Добавить тег" class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800">
                            <button id="addTagBtn" class="px-3 py-2 bg-blue-500 text-white rounded-r-md hover:bg-blue-600 transition">+</button>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Добавить этап</label>
                        <div class="space-y-2">
                            <input type="text" id="stageName" placeholder="Название этапа" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800">
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Добавить описание этапу</label>
                                <textarea id="stageDescription" placeholder="Описание этапа" rows="2" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800"></textarea>
                            </div>
                            
                            <button id="addStageBtn" class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition">
                                <i class="fas fa-plus mr-1"></i> Добавить этап
                            </button>
                        </div>
                    </div>
                    
                    <div id="stagesList" class="stages-container space-y-2 max-h-60 overflow-y-auto p-2 border border-gray-200 dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-800">
                        <p class="text-sm text-gray-500 dark:text-gray-400 italic">Этапы появятся здесь</p>
                    </div>
                    
                    <div class="flex space-x-3 pt-2">
                        <button id="saveRoadmapBtn" class="flex-1 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition flex items-center justify-center">
                            <i class="fas fa-save mr-2"></i> Сохранить
                        </button>
                        <button id="clearFormBtn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Просмотр RoadMap -->
            <div class="lg:col-span-2 space-y-8 mobile-full">
                <!-- Фильтр по тегам -->
                <div class="bg-white dark:bg-dark-850 rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4 flex items-center">
                        <i class="fas fa-filter mr-2 text-blue-500"></i> Фильтры
                    </h2>
                    <div class="flex flex-wrap gap-2" id="tagFiltersContainer">
                        <button class="tag-filter px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 rounded-full text-sm hover:bg-blue-200 dark:hover:bg-blue-800/50 transition active" data-tag="all">
                            Все
                        </button>
                        <!-- Теги будут добавлены динамически -->
                    </div>
                </div>
                
                <div class="bg-white dark:bg-dark-850 rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 mb-4 flex items-center">
                        <i class="fas fa-list mr-2 text-blue-500"></i> Ваши RoadMaps
                    </h2>
                    <div class="relative">
                        <input type="text" id="searchRoadmap" placeholder="Поиск RoadMap..." class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800">
                        <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                    </div>
                    
                    <div id="roadmapsList" class="space-y-4">
                        <!-- Пример RoadMap -->
                        <div class="roadmap-item bg-blue-50 dark:bg-blue-900/30 border border-blue-100 dark:border-blue-800 rounded-lg p-4 fade-in">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="font-bold text-lg text-blue-800 dark:text-blue-200">Пример RoadMap</h3>
                                    <p class="text-sm text-gray-600 dark:text-blue-100/80 mt-1">Это пример созданной дорожной карты для демонстрации</p>
                                </div>
                                <div class="flex space-x-2">
                                    <button class="view-btn px-3 py-1 bg-blue-100 dark:bg-blue-800/50 text-blue-600 dark:text-blue-200 rounded-md text-sm hover:bg-blue-200 dark:hover:bg-blue-700 transition">
                                        <i class="fas fa-eye mr-1"></i> Просмотр
                                    </button>
                                    <button class="delete-btn px-3 py-1 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-300 rounded-md text-sm hover:bg-red-200 dark:hover:bg-red-800/50 transition">
                                        <i class="fas fa-trash-alt mr-1"></i> Удалить
                                    </button>
                                </div>
                            </div>
                            <div class="mt-3 pt-3 border-t border-blue-100 dark:border-blue-800/50">
                                <div class="flex items-center text-sm text-gray-500 dark:text-blue-100/70">
                                    <i class="fas fa-calendar-alt mr-1"></i>
                                    <span>Создано: 01.01.2023</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Просмотр выбранного RoadMap -->
                <div id="roadmapView" class="bg-white dark:bg-dark-850 rounded-xl shadow-md p-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 id="viewTitle" class="text-2xl font-bold text-gray-800 dark:text-gray-100"></h2>
                            <p id="viewDescription" class="text-gray-600 dark:text-gray-300 mt-1"></p>
                        </div>
                        <button id="closeViewBtn" class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- Прогрессбар -->
                    <div class="mb-6">
                        <div class="flex justify-between text-sm text-gray-700 dark:text-gray-300 mb-1">
                            <span>Прогресс выполнения</span>
                            <span id="progressText">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="relative timeline py-4">
                        <div id="timelineContent" class="space-y-8">
                            <!-- Этапы будут добавлены сюда -->
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center text-sm text-gray-500 dark:text-gray-400">
                            <div>
                                <i class="fas fa-calendar-alt mr-1"></i>
                                <span id="viewDate"></span>
                            </div>
                            <button id="shareBtn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition flex items-center">
                                <i class="fas fa-share-alt mr-2"></i> Поделиться
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Кнопка создания на мобильных устройствах -->
    <button id="mobileCreateBtn" class="mobile-create-btn lg:hidden w-14 h-14 rounded-full bg-blue-500 text-white flex items-center justify-center hover:bg-blue-600 transition">
        <i class="fas fa-plus text-xl"></i>
    </button>

    <!-- Модальное окно для шаринга -->
    <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-dark-850 rounded-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">Поделиться RoadMap</h3>
                <button id="closeShareModal" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Ссылка для общего доступа</label>
                    <div class="flex">
                        <input type="text" id="shareLink" readonly class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-l-md focus:outline-none bg-gray-100 dark:bg-gray-800 dark:text-gray-200">
                        <button id="copyLinkBtn" class="px-4 py-2 bg-blue-500 text-white rounded-r-md hover:bg-blue-600 transition">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="flex justify-center space-x-4 pt-2">
                    <button class="p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition">
                        <i class="fab fa-facebook-f"></i>
                    </button>
                    <button class="p-3 bg-blue-400 text-white rounded-full hover:bg-blue-500 transition">
                        <i class="fab fa-twitter"></i>
                    </button>
                    <button class="p-3 bg-gray-800 text-white rounded-full hover:bg-gray-900 transition">
                        <i class="fab fa-telegram-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-gray-800 dark:bg-gray-900 text-white py-6 mt-12">
        <div class="container mx-auto px-4 text-center">
            <p>© 2025 RoadMap Creator. Все права не защищены.</p>
            <div class="flex justify-center space-x-4 mt-3">
                <a href="#" class="hover:text-blue-300 transition"><i class="fab fa-github"></i></a>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Тема
            const toggleTheme = document.getElementById('toggleTheme');
            const html = document.documentElement;

            if (localStorage.getItem('theme') === 'dark') {
                html.classList.add('dark');
                toggleTheme.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                toggleTheme.innerHTML = '<i class="fas fa-moon"></i>';
            }

    toggleTheme.addEventListener('click', () => {
        // Добавляем анимацию
        toggleTheme.classList.add('animate');

        // Удаляем анимацию после завершения
        setTimeout(() => {
            toggleTheme.classList.remove('animate');
        }, 400);

        // Переключение темы
        html.classList.toggle('dark');
        if (html.classList.contains('dark')) {
            localStorage.setItem('theme', 'dark');
            toggleTheme.innerHTML = '<i class="fas fa-sun"></i>';
        } else {
            localStorage.setItem('theme', 'light');
            toggleTheme.innerHTML = '<i class="fas fa-moon"></i>';
        }
    });
            
            // Управление панелью создания на мобильных
            const mobileCreateBtn = document.getElementById('mobileCreateBtn');
            const closeCreatePanel = document.getElementById('closeCreatePanel');
            const createPanel = document.getElementById('createPanel');
            
            mobileCreateBtn.addEventListener('click', () => {
                createPanel.classList.remove('mobile-hidden');
                createPanel.classList.add('fixed', 'inset-0', 'z-50', 'm-4', 'overflow-auto');
                document.body.classList.add('overflow-hidden');
            });
            
            closeCreatePanel.addEventListener('click', () => {
                createPanel.classList.add('mobile-hidden');
                createPanel.classList.remove('fixed', 'inset-0', 'z-50', 'm-4', 'overflow-auto');
                document.body.classList.remove('overflow-hidden');
            });
            
            // Работа с RoadMaps
            let roadmaps = JSON.parse(localStorage.getItem('roadmaps')) || [];
            let stages = [];
            let tags = [];
            let members = [];
            
            // Drag & Drop для этапов
            let draggedItem = null;
            
            function setupDragAndDrop() {
                document.querySelectorAll('.stage-item').forEach(item => {
                    item.setAttribute('draggable', true);
                    
                    item.addEventListener('dragstart', function(e) {
                        draggedItem = this;
                        this.classList.add('dragging');
                        e.dataTransfer.setData('text/plain', this.getAttribute('data-index'));
                    });
                    
                    item.addEventListener('dragend', function() {
                        this.classList.remove('dragging');
                        draggedItem = null;
                    });
                    
                    item.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        this.classList.add('drag-over');
                    });
                    
                    item.addEventListener('dragleave', function() {
                        this.classList.remove('drag-over');
                    });
                    
                    item.addEventListener('drop', function(e) {
                        e.preventDefault();
                        this.classList.remove('drag-over');
                        
                        if (draggedItem !== this) {
                            const targetIndex = parseInt(this.getAttribute('data-index'));
                            const draggedIndex = parseInt(draggedItem.getAttribute('data-index'));
                            
                            if (!isNaN(targetIndex) && !isNaN(draggedIndex)) {
                                // Перемещаем элемент в массиве stages
                                const draggedStage = stages[draggedIndex];
                                stages.splice(draggedIndex, 1);
                                stages.splice(targetIndex, 0, draggedStage);
                                
                                updateStagesList();
                            }
                        }
                    });
                });
            }
            
            // Теги RoadMap
            const addTagBtn = document.getElementById('addTagBtn');
            const tagInput = document.getElementById('tagInput');
            const tagsContainer = document.getElementById('tagsContainer');
            
            addTagBtn.addEventListener('click', () => {
                const tag = tagInput.value.trim();
                if (tag && !tags.includes(tag)) {
                    tags.push(tag);
                    renderTags();
                    tagInput.value = '';
                }
            });
            
            tagInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addTagBtn.click();
                }
            });
            
            function renderTags() {
                tagsContainer.innerHTML = '';
                tags.forEach(tag => {
                    const tagElement = document.createElement('div');
                    tagElement.className = 'tag';
                    tagElement.innerHTML = `
                        ${tag}
                        <span class="tag-remove" data-tag="${tag}">
                            <i class="fas fa-times"></i>
                        </span>
                    `;
                    tagsContainer.appendChild(tagElement);
                });
                
                document.querySelectorAll('.tag-remove').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const tagToRemove = this.parentElement.getAttribute('data-tag');
                        tags = tags.filter(t => t !== tagToRemove);
                        renderTags();
                    });
                });
            }
            
            // Добавление этапа
            const addStageBtn = document.getElementById('addStageBtn');
            const stageNameInput = document.getElementById('stageName');
            const stageDescriptionInput = document.getElementById('stageDescription');
            const stagesList = document.getElementById('stagesList');
            
            addStageBtn.addEventListener('click', () => {
                const stageName = stageNameInput.value.trim();
                const stageDescription = stageDescriptionInput.value.trim();
                
                if (stageName) {
                    stages.push({ 
                        name: stageName, 
                        description: stageDescription,
                        completed: false 
                    });
                    updateStagesList();
                    stageNameInput.value = '';
                    stageDescriptionInput.value = '';
                    stageNameInput.focus();
                }
            });
            
            stageNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addStageBtn.click();
                }
            });
            
            function updateStagesList() {
                if (stages.length === 0) {
                    stagesList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 italic">Этапы появятся здесь</p>';
                    return;
                }

                stagesList.innerHTML = '';
                stages.forEach((stage, index) => {
                    const stageElement = document.createElement('div');
                    stageElement.className = 'stage-item flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-md';
                    stageElement.setAttribute('data-index', index);

                    stageElement.innerHTML = `
                        <div class="flex items-start space-x-2 w-full">
                            <span class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-300 text-xs font-medium px-2 py-0.5 rounded mt-1">${index + 1}</span>
                            <div class="flex-1">
                                <div class="${stage.completed ? 'line-through text-green-500' : 'text-gray-800 dark:text-gray-300'}">${stage.name}</div>
                                ${stage.description ? `<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${stage.description}</div>` : ''}
                                
                                ${stage.tags && stage.tags.length > 0 ? `
                                    <div class="flex flex-wrap gap-1 mt-1">
                                        ${stage.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                    </div>
                                ` : ''}
                                
                                ${stage.comment ? `
                                    <div class="stage-comment mt-2">
                                        <p class="text-xs text-gray-600 dark:text-gray-400">${stage.comment}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button class="complete-stage text-green-500 hover:text-green-700 dark:hover:text-green-400 text-sm" data-index="${index}" title="Выполнено">
                                <i class="fas fa-check-circle"></i>
                            </button>
                            <button class="remove-stage text-red-500 hover:text-red-700 dark:hover:text-red-400" data-index="${index}" title="Удалить">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    stagesList.appendChild(stageElement);
                });

                // Обработчики
                document.querySelectorAll('.remove-stage').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const index = parseInt(this.getAttribute('data-index'));
                        stages.splice(index, 1);
                        updateStagesList();
                    });
                });

                document.querySelectorAll('.complete-stage').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const index = parseInt(this.getAttribute('data-index'));
                        stages[index].completed = !stages[index].completed;
                        updateStagesList();
                    });
                });
                
                // Настраиваем Drag & Drop
                setupDragAndDrop();
            }
            
            // Сохранение RoadMap
            const saveRoadmapBtn = document.getElementById('saveRoadmapBtn');
            const roadmapTitle = document.getElementById('roadmapTitle');
            const roadmapDescription = document.getElementById('roadmapDescription');
            const roadmapsList = document.getElementById('roadmapsList');
            
            saveRoadmapBtn.addEventListener('click', () => {
                const title = roadmapTitle.value.trim();
                const description = roadmapDescription.value.trim();
                
                if (!title) {
                    alert('Пожалуйста, укажите название RoadMap');
                    return;
                }
                
                if (stages.length === 0) {
                    alert('Пожалуйста, добавьте хотя бы один этап');
                    return;
                }
                
                const newRoadmap = {
                    id: Date.now(),
                    title,
                    description,
                    tags: [...tags],
                    members: [...members],
                    stages: [...stages],
                    createdAt: new Date().toLocaleDateString('ru-RU')
                };
                
                roadmaps.unshift(newRoadmap);
                localStorage.setItem('roadmaps', JSON.stringify(roadmaps));
                
                renderRoadmapsList();
                renderTagFilters();
                clearForm();
                
                // Анимация успешного сохранения
                saveRoadmapBtn.innerHTML = '<i class="fas fa-check mr-2"></i> Сохранено!';
                saveRoadmapBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                saveRoadmapBtn.classList.add('bg-green-600');
                
                setTimeout(() => {
                    saveRoadmapBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Сохранить';
                    saveRoadmapBtn.classList.remove('bg-green-600');
                    saveRoadmapBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                }, 2000);
                
                // На мобильных устройствах закрываем панель после сохранения
                if (window.innerWidth < 1024) {
                    createPanel.classList.add('mobile-hidden');
                    createPanel.classList.remove('fixed', 'inset-0', 'z-50', 'm-4', 'overflow-auto');
                    document.body.classList.remove('overflow-hidden');
                }
            });
            
            // Очистка формы
            const clearFormBtn = document.getElementById('clearFormBtn');
            clearFormBtn.addEventListener('click', clearForm);
            
            function clearForm() {
                roadmapTitle.value = '';
                roadmapDescription.value = '';
                stageNameInput.value = '';
                stageDescriptionInput.value = '';
                
                // Если были добавлены поля:
                if (typeof stageTagInput !== 'undefined') stageTagInput.value = '';
                if (typeof stageCommentInput !== 'undefined') stageCommentInput.value = '';

                // Очистить массивы
                tags = [];
                stages = [];

                // Перерисовать
                renderTags();
                updateStagesList();
            }
            
            // Расчет прогресса
            function calculateProgress(roadmap) {
                const total = roadmap.stages.length;
                const completed = roadmap.stages.filter(s => s.completed).length;
                return total > 0 ? Math.round((completed / total) * 100) : 0;
            }
            
            // Рендер списка RoadMaps
            function renderRoadmapsList(filter = '', tagFilter = null) {
                roadmapsList.innerHTML = '';
                
                let filteredRoadmaps = roadmaps;
                
                // Фильтрация по поиску
                if (filter) {
                    filteredRoadmaps = filteredRoadmaps.filter(roadmap => 
                        roadmap.title.toLowerCase().includes(filter.toLowerCase()) || 
                        roadmap.description.toLowerCase().includes(filter.toLowerCase())
                    );
                }
                
                // Фильтрация по тегу
                if (tagFilter && tagFilter !== 'all') {
                    filteredRoadmaps = filteredRoadmaps.filter(roadmap => 
                        roadmap.tags && roadmap.tags.includes(tagFilter)
                    );
                }
                
                if (filteredRoadmaps.length === 0) {
                    roadmapsList.innerHTML = `
                        <div class="text-center py-8">
                            <i class="fas fa-road text-4xl text-gray-300 dark:text-gray-600 mb-3"></i>
                            <p class="text-gray-500 dark:text-gray-400">RoadMaps не найдены</p>
                        </div>
                    `;
                    return;
                }
                
                filteredRoadmaps.forEach(roadmap => {
                    const progress = calculateProgress(roadmap);
                    
                    const roadmapElement = document.createElement('div');
                    roadmapElement.className = 'roadmap-item bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg p-4 fade-in slide-in';
                    
                    roadmapElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg text-gray-800 dark:text-gray-100">${roadmap.title}</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">${roadmap.description || 'Нет описания'}</p>
                                
                                ${roadmap.tags && roadmap.tags.length > 0 ? `
                                    <div class="flex flex-wrap gap-1 mt-2">
                                        ${roadmap.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="flex space-x-2">
                                <button class="view-btn px-3 py-1 bg-blue-100 dark:bg-blue-800/50 text-blue-600 dark:text-blue-200 rounded-md text-sm hover:bg-blue-200 dark:hover:bg-blue-700 transition" data-id="${roadmap.id}">
                                    <i class="fas fa-eye mr-1"></i> Просмотр
                                </button>
                                <button class="delete-btn px-3 py-1 bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-300 rounded-md text-sm hover:bg-red-200 dark:hover:bg-red-800/50 transition" data-id="${roadmap.id}">
                                    <i class="fas fa-trash-alt mr-1"></i> Удалить
                                </button>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
                            <div class="flex justify-between items-center">
                                <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                                    <i class="fas fa-calendar-alt mr-1"></i>
                                    <span>Создано: ${roadmap.createdAt}</span>
                                </div>
                                <div class="text-sm font-medium text-gray-700 dark:text-gray-300">
                                    <span>${progress}% завершено</span>
                                </div>
                            </div>
                            <div class="progress-bar mt-2">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    `;
                    roadmapsList.appendChild(roadmapElement);
                });
                
                // Добавляем обработчики для кнопок просмотра и удаления
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        viewRoadmap(id);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        deleteRoadmap(id);
                    });
                });
            }
            
            // Рендер фильтров по тегам
            function renderTagFilters() {
                const tagFiltersContainer = document.getElementById('tagFiltersContainer');
                // Оставляем кнопку "Все"
                tagFiltersContainer.innerHTML = '<button class="tag-filter px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 rounded-full text-sm hover:bg-blue-200 dark:hover:bg-blue-800/50 transition active" data-tag="all">Все</button>';
                
                // Собираем все уникальные теги из всех RoadMaps
                const allTags = [...new Set(roadmaps.flatMap(r => r.tags || []))];
                
                allTags.forEach(tag => {
                    const button = document.createElement('button');
                    button.className = 'tag-filter px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition';
                    button.textContent = tag;
                    button.setAttribute('data-tag', tag);
                    tagFiltersContainer.appendChild(button);
                });
                
                // Обработчики для фильтров
                document.querySelectorAll('.tag-filter').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const tag = this.getAttribute('data-tag');
                        
                        // Обновляем активное состояние
                        document.querySelectorAll('.tag-filter').forEach(b => 
                            b.classList.remove('active')
                        );
                        this.classList.add('active');
                        
                        // Применяем фильтр
                        renderRoadmapsList(searchRoadmap.value, tag);
                    });
                });
            }
            
            // Просмотр RoadMap
            const roadmapView = document.getElementById('roadmapView');
            const viewTitle = document.getElementById('viewTitle');
            const viewDescription = document.getElementById('viewDescription');
            const viewDate = document.getElementById('viewDate');
            const timelineContent = document.getElementById('timelineContent');
            const closeViewBtn = document.getElementById('closeViewBtn');
            const progressText = document.getElementById('progressText');
            const progressFill = document.querySelector('.progress-fill');

            function renderTags() {
                tagsContainer.innerHTML = '';
                tags.forEach(tag => {
                    const tagElement = document.createElement('div');
                    tagElement.className = 'tag';
                    tagElement.setAttribute('data-tag', tag); // ВАЖНО: нужно для удаления
                    tagElement.innerHTML = `
                        ${tag}
                        <span class="tag-remove" data-tag="${tag}">
                            <i class="fas fa-times"></i>
                        </span>
                    `;
                    tagsContainer.appendChild(tagElement);
                });
                // Привязка обработчиков после отрисовки
                document.querySelectorAll('.tag-remove').forEach(btn => {
                    btn.addEventListener('click', function () {
                        const tagToRemove = this.getAttribute('data-tag');
                        tags = tags.filter(t => t !== tagToRemove);
                        renderTags(); // перерисовываем список
                    });
                });
            }

            function viewRoadmap(id) {
                const roadmap = roadmaps.find(r => r.id === id);
                if (!roadmap) return;
                
                viewTitle.textContent = roadmap.title;
                viewTitle.setAttribute('data-id', roadmap.id);
                viewDescription.textContent = roadmap.description || 'Нет описания';
                viewDate.textContent = `Создано: ${roadmap.createdAt}`;
                
                // Обновляем прогрессбар
                const progress = calculateProgress(roadmap);
                progressText.textContent = `${progress}%`;
                progressFill.style.width = `${progress}%`;
                
                timelineContent.innerHTML = '';
                roadmap.stages.forEach((stage, index) => {
                    const stageElement = document.createElement('div');
                    stageElement.className = `relative ${index % 2 === 0 ? 'lg:pr-24' : 'lg:pl-24'} ${stage.completed ? 'stage-completed' : ''}`;
                    
                    const dotClass = index % 2 === 0 ? 'left-0 lg:left-1/2' : 'left-0 lg:left-1/2';
                    const contentClass = index % 2 === 0 ? 'lg:mr-6' : 'lg:ml-6';
                    
                    stageElement.innerHTML = `
                        <div class="stage-dot absolute w-4 h-4 rounded-full bg-blue-500 border-4 border-white dark:border-gray-800 -left-2 ${dotClass} -translate-x-1/2 top-6 z-10"></div>
                        <div class="stage-content bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 ${contentClass}">
                            <div class="flex items-center mb-2">
                                <span class="bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded mr-2">Этап ${index + 1}</span>
                                <h4 class="font-semibold text-gray-800 dark:text-gray-200 stage-title">${stage.name}</h4>
                            </div>
                            ${stage.description ? `<p class="text-sm text-gray-600 dark:text-gray-300 mt-2">${stage.description}</p>` : ''}
                            
                            ${stage.tags && stage.tags.length > 0 ? `
                                <div class="flex flex-wrap gap-1 mt-2">
                                    ${stage.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                </div>
                            ` : ''}
                            
                            ${stage.comment ? `
                                <div class="stage-comment">
                                    <p class="text-sm text-gray-700 dark:text-gray-300">${stage.comment}</p>
                                </div>
                            ` : ''}
                            
                            <div class="flex justify-between items-center mt-4">
                                <div class="flex space-x-2">
                                    <span class="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-gray-600 dark:text-gray-300">${stage.completed ? 'Завершено' : 'В процессе'}</span>
                                </div>
                                <button class="complete-stage-btn px-3 py-1 ${stage.completed ? 'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-300' : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300'} rounded-md text-sm hover:opacity-90 transition" data-roadmap-id="${roadmap.id}" data-stage-index="${index}">
                                    <i class="fas ${stage.completed ? 'fa-check-circle' : 'fa-circle'} mr-1"></i> ${stage.completed ? 'Выполнено' : 'Отметить'}
                                </button>
                            </div>
                        </div>
                    `;
                    timelineContent.appendChild(stageElement);
                });
                
                // Добавляем обработчики для кнопок выполнения этапов
                document.querySelectorAll('.complete-stage-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const roadmapId = parseInt(this.getAttribute('data-roadmap-id'));
                        const stageIndex = parseInt(this.getAttribute('data-stage-index'));
                        toggleStageCompletion(roadmapId, stageIndex);
                    });
                });
                
                roadmapView.classList.remove('hidden');
                roadmapView.classList.add('slide-in');
                window.scrollTo({
                    top: roadmapView.offsetTop - 20,
                    behavior: 'smooth'
                });
            }
            
            // Переключение статуса выполнения этапа
            function toggleStageCompletion(roadmapId, stageIndex) {
                const roadmap = roadmaps.find(r => r.id === roadmapId);
                if (!roadmap) return;
                
                // Инвертируем статус выполнения
                roadmap.stages[stageIndex].completed = !roadmap.stages[stageIndex].completed;
                
                // Сохраняем обновленные данные
                localStorage.setItem('roadmaps', JSON.stringify(roadmaps));
                
                // Обновляем отображение RoadMap
                viewRoadmap(roadmapId);
                
                // Обновляем список RoadMaps
                renderRoadmapsList();
            }
            
            closeViewBtn.addEventListener('click', () => {
                roadmapView.classList.add('slide-out');
                setTimeout(() => {
                    roadmapView.classList.add('hidden');
                    roadmapView.classList.remove('slide-out');
                }, 300);
            });
            
            // Удаление RoadMap
            function deleteRoadmap(id) {
                if (confirm('Вы уверены, что хотите удалить этот RoadMap?')) {
                    const roadmapElement = document.querySelector(`.roadmap-item .delete-btn[data-id="${id}"]`).closest('.roadmap-item');
                    roadmapElement.classList.add('slide-out');
                    
                    setTimeout(() => {
                        roadmaps = roadmaps.filter(r => r.id !== id);
                        localStorage.setItem('roadmaps', JSON.stringify(roadmaps));
                        renderRoadmapsList();
                        renderTagFilters();
                        
                        // Если удаляем просматриваемый RoadMap, закрываем просмотр
                        if (viewTitle.getAttribute('data-id') == id) {
                            roadmapView.classList.add('hidden');
                        }
                    }, 300);
                }
            }
            
            // Поиск RoadMap
            const searchRoadmap = document.getElementById('searchRoadmap');
            
            searchRoadmap.addEventListener('input', () => {
                const activeFilter = document.querySelector('.tag-filter.active');
                const tag = activeFilter ? activeFilter.getAttribute('data-tag') : 'all';
                renderRoadmapsList(searchRoadmap.value, tag);
            });
            
            // Шаринг RoadMap
            const shareBtn = document.getElementById('shareBtn');
            const shareModal = document.getElementById('shareModal');
            const closeShareModal = document.getElementById('closeShareModal');
            const shareLink = document.getElementById('shareLink');
            const copyLinkBtn = document.getElementById('copyLinkBtn');
            
            shareBtn.addEventListener('click', () => {
                const currentRoadmapId = viewTitle.getAttribute('data-id');
                if (currentRoadmapId) {
                    const url = `${window.location.origin}${window.location.pathname}?roadmap=${currentRoadmapId}`;
                    shareLink.value = url;
                    shareModal.classList.remove('hidden');
                }
            });
            
            closeShareModal.addEventListener('click', () => {
                shareModal.classList.add('hidden');
            });
            
            copyLinkBtn.addEventListener('click', () => {
                shareLink.select();
                document.execCommand('copy');
                
                copyLinkBtn.innerHTML = '<i class="fas fa-check mr-1"></i> Скопировано';
                setTimeout(() => {
                    copyLinkBtn.innerHTML = '<i class="fas fa-copy"></i>';
                }, 2000);
            });
            
            // Проверка URL на наличие параметра roadmap
            function checkUrlForRoadmap() {
                const urlParams = new URLSearchParams(window.location.search);
                const roadmapId = urlParams.get('roadmap');
                
                if (roadmapId) {
                    const roadmap = roadmaps.find(r => r.id === parseInt(roadmapId));
                    if (roadmap) {
                        viewRoadmap(roadmap.id);
                    }
                }
            }
            
            // Инициализация
            renderRoadmapsList();
            renderTagFilters();
            checkUrlForRoadmap();
        });
    </script>
</body>
</html>